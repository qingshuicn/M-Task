---
name: 数据库设计与模型实现
status: in-review
created: 2025-09-04T13:59:12Z
updated: 2025-09-04T13:59:12Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: 数据库设计与模型实现

## Description

设计数据库架构，创建数据表结构，实现 ORM 模型和迁移脚本，为系统提供数据持久化基础。

## Acceptance Criteria

- [x] PostgreSQL 数据库连接配置完成
- [x] 所有核心数据表创建（branch, user, task_template, task_instance, task_step, attachment, notification_log, audit_log）
- [x] TypeORM entities 定义完成
- [x] 数据库迁移脚本准备就绪
- [x] Redis 连接配置完成
- [x] 基础 CRUD repository 实现

## Completion Notes

- 在 NestJS 应用中引入 `@nestjs/config` + `@nestjs/typeorm`，基于环境变量加载 Postgres 连接，生产/开发环境均支持。
- 使用 TypeORM 定义核心实体模型，补齐任务、用户、模板、通知、附件及审计日志之间的关联与软删除字段。
- 编写初始化迁移 `InitCoreSchema1736016000000`，创建全部业务表、唯一索引和外键约束，包含 JSONB 字段与默认值。
- 通过全局 `DatabaseModule` 暴露仓储类，为核心实体提供统一的 CRUD 接口，便于后续业务模块调用。
- 集成基于 ioredis 的 `RedisModule`，集中管理 Redis 连接配置和生命周期，为缓存与队列功能做好准备。
- 新增迁移执行脚本（run/revert/show），通过 pnpm script 可直接运行，保证 schema 迭代的可控性。

## Technical Details

- 使用 TypeORM + PostgreSQL，禁用自动同步，全部 schema 变更通过 migrations 管控。
- 默认启用 `pgcrypto` 扩展，所有主键使用 `gen_random_uuid()` 生成。
- 任务步骤、模板步骤采用 JSONB 存储结构化数据，满足灵活拓展。
- 通知日志、审核日志等表提供索引与外键，支持后续审计和追踪查询。
- Redis 连接采用 lazy connect + 限制重试，避免开发环境频繁重连。

## Dependencies

- [x] Task 001 完成（项目结构搭建）
- [x] PostgreSQL 服务可访问
- [x] Redis 服务可访问

## Effort Estimate

- Size: L
- Hours: 16-20
- Parallel: false

## Definition of Done

- [x] 数据库连接成功
- [x] 所有表结构创建完成
- [x] ORM 模型定义完成
- [x] 迁移脚本可正常执行
- [x] 基础 CRUD 测试通过
- [x] 数据库设计文档更新
