---
name: 任务管理核心功能
status: in-progress
created: 2025-09-04T13:59:12Z
updated: 2025-09-05T09:30:00Z
github: [Will be updated when synced to GitHub]
depends_on: [003]
parallel: false
conflicts_with: []
---

# Task: 任务管理核心功能

## Description

实现任务模板管理、任务实例创建与发布、任务状态流转等核心业务功能。

## Acceptance Criteria

- [ ] 任务模板 CRUD API 实现
- [ ] 任务模板版本控制功能
- [ ] 任务实例创建和发布流程
- [ ] 任务步骤管理功能
- [ ] 任务状态机实现（待开始→进行中→待审核→已完成/已退回）
- [ ] 任务分配和转交功能
- [ ] 批量任务操作支持

## Technical Details

- 任务步骤使用 JSONB 存储，支持动态结构
- 实现状态机模式管理任务流转
- 使用事务确保数据一致性
- 实现乐观锁防止并发冲突
- 任务发布触发事件（用于通知）
- API 支持分页、筛选、排序

### 数据模型扩展

- `task_templates`
  - 字段：`id (uuid)`, `code`, `name`, `description`, `version`, `latest`, `effective_from`, `effective_to`, `steps (jsonb)`, `metadata (jsonb)`, `created_by`, `created_at`, `updated_at`。
  - 约束：`code + version` 唯一；`latest` 通过触发器或服务层保证单一真值。
- `task_instances`
  - 字段：`id (uuid)`, `template_id`, `title`, `branch_id`, `assignee_id`, `reviewer_id`, `status`, `payload (jsonb)`, `due_at`, `published_at`, `completed_at`, `version`, `lock_version`。
  - 约束：`status` 受限于状态机枚举；`version` 对齐模板版本，`lock_version` 用于乐观锁。
- `task_steps`
  - 字段：`id`, `task_instance_id`, `step_key`, `status`, `assignee_id`, `payload (jsonb)`, `started_at`, `completed_at`, `lock_version`。
  - 存储策略：若步骤信息简单，可内嵌在 `task_instances.payload`，复杂场景切换到独立表并通过 JSONB 索引加速查询。
- 审计字段统一复用 `BaseEntity`，补齐 `created_by/updated_by` 以满足责任追踪要求。

### 核心流程

1. **模板管理**
   - `POST /task-templates`：创建模板草稿，默认 `latest=true` 且 `version=1`。
   - `PATCH /task-templates/:id`：限制仅草稿可编辑；发布时冻结结构并写入审计日志。
   - `POST /task-templates/:id/clone`：基于已发布模板生成新版本，`version + 1`，`latest=true`。
   - 列表接口支持按照 `code`、`version`、`latest` 过滤。
2. **实例创建与发布**
   - 支持单个与批量创建，批量场景需开启事务并在 200 条以内分页处理。
   - 发布实例时写入 `task_events` 队列，触发通知与后续审批流。
   - 实例创建需校验模板为最新版本，若非最新提示更新。
3. **状态机流转**
   - 状态机定义：`DRAFT -> PENDING -> IN_PROGRESS -> WAITING_REVIEW -> (COMPLETED | REJECTED)`，驳回需写入 `status_reason` 记录说明。
   - 支持自定义回退规则：审核驳回回退到 `IN_PROGRESS` 并记录驳回原因。
   - 状态流转统一走 `TaskStateService`，封装权限校验、并发控制、事件发布。
4. **任务分配**
   - `assign` 操作仅限 `BRANCH_ADMIN` 或 `PGD_OFFICER`，支持向多人分配时自动拆分实例或维护多 assignee。
   - 需要与用户目录同步，缓存用户信息以降低数据库压力。
5. **批量操作**
   - 支持批量发布、批量分配、批量状态更新，所有批量 API 必须具备幂等性，返回每个任务的成功/失败明细。

### 集成点与系统约束

- **权限系统**：所有 API 接入 `JwtAuthGuard` 与 `PermissionsGuard`，细化 `task-template:*`、`task-instance:*`、`task-step:*` 权限位。
- **通知系统**：发布、状态变更、指派等事件通过 `TaskEventEmitter` 投递到消息总线，封装在 `TaskEventType` 枚举中。
- **审计日志**：采用现有 `AuditModule`（若无则补齐）记录敏感操作，确保满足合规要求。
- **性能要求**：关键列表查询需建立 `branch_id + status`、`assignee_id + status` 等组合索引，批量操作应限制事务窗口 < 5 秒。
- **幂等性**：对外暴露的批量接口需携带 `Idempotency-Key` 请求头，通过 Redis 锁防止重复提交。

## Recent Progress (2025-09-05)

- 完成任务模板、任务实例、任务步骤实体字段扩充，补齐 `latest`、`lock_version`、`status_reason` 等约束字段，并落实创建/更新人外键。
- 更新首版数据库迁移，新增模板版本唯一索引、任务实例分支/指派/审核组合索引以及步骤状态索引，保证后续批量与筛选性能。
- 为步骤、实例结构补充 JSONB 默认值与事务并发控制字段，为状态流转记录驳回原因提供存储位点。

## Dependencies

- [ ] Task 003 完成（认证系统）
- [x] 数据库模型就绪
- [ ] 权限系统可用

## Work Breakdown Structure

1. **Domain & Schema 设计（2d）**：完善 ER 图、数据库迁移与状态机定义，评审通过后进入开发。（✅ 初版实体与迁移已提交，等待代码评审）
2. **任务模板服务（3d）**：实现模板 CRUD、版本克隆、发布流程及单元测试。
3. **任务实例与状态机（5d）**：落地实例创建、状态流转、事务/乐观锁、事件触发。
4. **批量与分配能力（3d）**：封装批量操作、指派/转交 API，并编写并发测试。
5. **集成与文档（2d）**：补充 OpenAPI、使用指南，拉通通知、权限系统的集成验证。

## Milestones & Deliverables

- **M1：Schema & 模板 API 完成**（T+5d）
  - 数据迁移脚本、模板 CRUD API、版本控制测试通过。
- **M2：实例状态机可用**（T+10d）
  - 实例创建/发布、状态机服务、事件发布接口落地。
- **M3：批量与集成验收**（T+14d）
  - 批量操作上线、权限/通知/审计联调通过、端到端集成测试记录。

## Effort Estimate

- Size: XL
- Hours: 24-32
- Parallel: false

## Definition of Done

- [ ] 所有 API 端点实现并测试
- [ ] 状态流转逻辑测试通过
- [ ] 事务和并发控制测试
- [ ] API 文档完整
- [ ] 业务逻辑单测覆盖 > 90%
- [ ] 集成测试通过
